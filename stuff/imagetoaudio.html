<!DOCTYPE html>
<html>
<head>
  <title>image to audio (16-bit stereo)</title>
  <style>
    body { background: #000; color: #0f8; font-family: monospace; padding: 20px; }
    input, button {
      background: #001f1a; color: #0f8; border: 1px solid #0f8;
      font-family: monospace; padding: 8px; margin-top: 10px;
    }
    #log { margin-top: 10px; white-space: pre-wrap; border: 1px solid #0f8; padding: 10px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>image to audio (16-bit stereo)</h2>
  <input type="file" id="imageInput" accept="image/*"><br>
  <button onclick="playAudio()">play audio</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="log"></div>

  <script>
    let audioBuffer = null;
    let sourceNode = null;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const log = msg => {
      const box = document.getElementById('log');
      box.textContent += msg + '\n';
      box.scrollTop = box.scrollHeight;
      console.log(msg);
    };

    document.getElementById('imageInput').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;
      document.getElementById('log').textContent = '';
      log(`üì• selected: ${file.name}`);

      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = () => {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const data = ctx.getImageData(0, 0, img.width, img.height).data;

        const header = data.slice(0, 12);
        if (header[0] !== 0xA0 || header[1] !== 0x16) {
          log("‚ùå invalid metadata in image.");
          return;
        }

        const sampleRate = (header[2] << 8) + header[3];
        const sampleCount = (header[4] << 24) | (header[5] << 16) | (header[6] << 8) | header[7];

        log(`üéö sample rate: ${sampleRate}`);
        log(`üéß samples: ${sampleCount}`);

        const left = new Float32Array(sampleCount);
        const right = new Float32Array(sampleCount);
        let byteIndex = 12;

        for (let i = 0; i < sampleCount; i++) {
          const l16 = (data[byteIndex++] << 8) | data[byteIndex++];
          const r16 = (data[byteIndex++] << 8) | data[byteIndex++];
          left[i] = (l16 / 32767.5) - 1;
          right[i] = (r16 / 32767.5) - 1;
        }

        audioBuffer = audioCtx.createBuffer(2, sampleCount, sampleRate);
        audioBuffer.copyToChannel(left, 0);
        audioBuffer.copyToChannel(right, 1);
        log(`‚úÖ audio loaded.`);
      };
    });

    function playAudio() {
      if (!audioBuffer) return alert("No valid audio loaded.");
      if (sourceNode) sourceNode.disconnect();
      sourceNode = audioCtx.createBufferSource();
      sourceNode.buffer = audioBuffer;
      sourceNode.connect(audioCtx.destination);
      sourceNode.start();
      log(`‚ñ∂Ô∏è playing audio...`);
    }
  </script>
</body>
</html>
