<!DOCTYPE html>
<html>
<head>
  <title>audio to image (16-bit stereo)</title>
  <style>
    body { background: #000; color: #0f8; font-family: monospace; padding: 20px; }
    input, button, a {
      background: #001f1a; color: #0f8; border: 1px solid #0f8;
      font-family: monospace; padding: 8px; margin-top: 10px;
    }
    #log { margin-top: 10px; white-space: pre-wrap; border: 1px solid #0f8; padding: 10px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>audio to image (16-bit stereo)</h2>
  <input type="file" id="audioInput" accept="audio/*"><br>
  <button onclick="convertAudio()">convert</button>
  <a id="downloadLink" download="audio-image.png" style="display:none;">download audio-image.png</a>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="log"></div>

  <script>
    const log = msg => {
      const box = document.getElementById('log');
      box.textContent += msg + '\n';
      box.scrollTop = box.scrollHeight;
      console.log(msg);
    };

    async function convertAudio() {
      const file = document.getElementById('audioInput').files[0];
      if (!file) return alert('Select an audio file first.');
      document.getElementById('log').textContent = '';
      log(`ðŸ“¥ selected: ${file.name}`);

      const arrayBuffer = await file.arrayBuffer();
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      const sampleRate = audioBuffer.sampleRate;
      const left = audioBuffer.getChannelData(0);
      const right = audioBuffer.numberOfChannels > 1 ? audioBuffer.getChannelData(1) : left;

      const sampleCount = Math.min(left.length, right.length);
      const bytesNeeded = 12 + (sampleCount * 4); // 12 bytes metadata, 4 bytes per stereo sample
      const pixelCount = Math.ceil(bytesNeeded / 4);
      const width = Math.ceil(Math.sqrt(pixelCount));
      const height = Math.ceil(pixelCount / width);
      const pixelData = new Uint8ClampedArray(width * height * 4);

      // --- metadata: 3 pixels (12 bytes)
      const metadata = [
        0xA0, 0x16,                             // magic header
        (sampleRate >> 8) & 0xFF,
        sampleRate & 0xFF,
        (sampleCount >> 24) & 0xFF,
        (sampleCount >> 16) & 0xFF,
        (sampleCount >> 8) & 0xFF,
        sampleCount & 0xFF,
        0x00, 0x00, 0x00, 0xFF                  // filler (can use for flags)
      ];
      for (let i = 0; i < 12; i++) pixelData[i] = metadata[i];

      // --- encode audio
      let byteIndex = 12;
      for (let i = 0; i < sampleCount; i++) {
        const l = Math.max(-1, Math.min(1, left[i]));
        const r = Math.max(-1, Math.min(1, right[i]));
        const l16 = Math.round((l + 1) * 32767.5);
        const r16 = Math.round((r + 1) * 32767.5);

        pixelData[byteIndex++] = (l16 >> 8) & 0xFF;
        pixelData[byteIndex++] = l16 & 0xFF;
        pixelData[byteIndex++] = (r16 >> 8) & 0xFF;
        pixelData[byteIndex++] = r16 & 0xFF;
      }

      // --- write image
      const canvas = document.getElementById('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      const imageData = new ImageData(pixelData, width, height);
      ctx.putImageData(imageData, 0, 0);

      const link = document.getElementById('downloadLink');
      link.href = canvas.toDataURL("image/png");
      link.style.display = 'inline';

      log(`ðŸŽš sample rate: ${sampleRate}`);
      log(`ðŸŽ§ channels: stereo`);
      log(`ðŸ§ª samples: ${sampleCount}`);
      log(`ðŸ–¼ image size: ${width}x${height}`);
      log(`âœ… conversion complete.`);
    }
  </script>
</body>
</html>
