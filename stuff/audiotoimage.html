<!DOCTYPE html>
<html>
<head>
  <title>audio to image (debug)</title>
  <style>
    body {
      background-color: #000;
      color: #00ff88;
      font-family: 'Courier New', monospace;
      text-transform: lowercase;
      text-shadow: 0 0 5px #00ff88;
      padding: 20px;
    }
    input, button, a {
      background-color: #001f1a;
      color: #00ff88;
      border: 1px solid #00ff88;
      font-family: 'Courier New', monospace;
      padding: 8px;
      margin: 5px 0;
    }
    #log {
      white-space: pre-wrap;
      background-color: #001f1a;
      border: 1px solid #00ff88;
      padding: 10px;
      margin-top: 10px;
      height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }
  </style>
<meta property="og:title" content="audio to image"/>
<meta property="og:description" content="convert an audio into an image"/>
<meta property="og:image" content="https://www.qwertywaffle.xyz/stuff/a2i.png"/>
<meta property="og:url" content="https://www.qwertywaffle.xyz/stuff/audiotoimage"/>
<meta property="og:type" content="website"/>
</head>
<body>
  <h2>audio to image (debug)</h2>
  <p>convert the image into an audio again at https://www.qwertywaffle.xyz/stuff/imagetoaudio</p>
  <input type="file" accept="audio/*" id="audioInput"><br>
  <button id="convertBtn">convert</button>
  <a id="downloadLink" download="audio-image.png" style="display:none;">download</a>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="log"></div>

  <script>
    const logBox = document.getElementById('log');
    const log = (msg) => {
      console.log(msg);
      logBox.textContent += msg + '\n';
      logBox.scrollTop = logBox.scrollHeight;
    };

    document.getElementById('convertBtn').onclick = async () => {
      const file = document.getElementById('audioInput').files[0];
      if (!file) return alert("please select an audio file first.");

      logBox.textContent = '';
      log(`ðŸ“¥ selected: ${file.name} (${Math.round(file.size/1024)} KB)`);

      const arrayBuffer = await file.arrayBuffer();
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const originalBuffer = await audioCtx.decodeAudioData(arrayBuffer);

      // Resample to 44100 Hz using OfflineAudioContext
      const sampleRate = 44100;
      const offlineCtx = new OfflineAudioContext(
        1,
        Math.ceil(originalBuffer.length * sampleRate / originalBuffer.sampleRate),
        sampleRate
      );
      const source = offlineCtx.createBufferSource();
      source.buffer = originalBuffer;
      source.connect(offlineCtx.destination);
      source.start(0);
      const renderedBuffer = await offlineCtx.startRendering();
      let samples = renderedBuffer.getChannelData(0).slice();

      log(`ðŸ”Š (original: ${originalBuffer.sampleRate} Hz) resampled to ${sampleRate} Hz`);
      log(`ðŸ”‰ total samples: ${samples.length}`);

      // Normalize samples
      let peak = 0;
      for (let i = 0; i < samples.length; i++) {
        if (Math.abs(samples[i]) > peak) peak = Math.abs(samples[i]);
      }
      if (peak < 1e-5) peak = 1;
      for (let i = 0; i < samples.length; i++) {
        samples[i] /= peak;
      }

      // Compute image dimensions
      const totalPixels = Math.ceil(samples.length / 4) + 1;
      const width = Math.ceil(Math.sqrt(totalPixels));
      const height = Math.ceil(totalPixels / width);
      log(`ðŸ–¼ image size: ${width} x ${height}`);

      const pixelData = new Uint8ClampedArray(width * height * 4);

      // Store full 32-bit sample rate in first 4 bytes
      pixelData[0] = (sampleRate >> 24) & 0xFF;
      pixelData[1] = (sampleRate >> 16) & 0xFF;
      pixelData[2] = (sampleRate >> 8) & 0xFF;
      pixelData[3] = sampleRate & 0xFF;

      // Encode samples to pixel RGBA bytes
      let sampleIndex = 0;
      for (let i = 1; i < totalPixels; i++) {
        const dataIndex = i * 4;
        for (let c = 0; c < 4; c++) {
          const val = samples[sampleIndex++] || 0;
          pixelData[dataIndex + c] = Math.max(0, Math.min(255, Math.round((val + 1) * 127.5)));
        }
      }

      // Draw to canvas and export PNG
      const canvas = document.getElementById('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      const imageData = new ImageData(pixelData, width, height);
      ctx.putImageData(imageData, 0, 0);

      const link = document.getElementById('downloadLink');
      link.href = canvas.toDataURL("image/png");
      link.style.display = 'inline';
      link.textContent = 'download audio-image.png';

      log(`âœ… encoding complete. click download to save image.`);
    };
  </script>
</body>
</html>
